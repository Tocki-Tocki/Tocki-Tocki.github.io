<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RifaOP - Gran Rifa</title>
    
    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        :root {
            --md-sys-color-primary: #E53935; /* Rojo Vibrante */
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-surface: #FFFBFE;
            --md-sys-color-on-surface: #1C1B1F;
            --md-sys-color-outline: #79747E;
            
            --raffle-color-available: #FFFFFF;
            --raffle-color-pending: #FFECB3; /* Amarillo */
            --raffle-color-sold: #C8E6C9; /* Verde */
            --raffle-color-loser: #FFCDD2; /* Rojo Claro */
            --raffle-text-pending: #6D4C41;
            --raffle-text-sold: #1B5E20;
            --raffle-text-loser: #B71C1C;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            margin: 0;
            padding: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: 800px;
            text-align: center;
        }

        /* --- ESTILO DE ENCABEZADO RESTAURADO Y AJUSTADO --- */
        .header-main {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px; /* Espacio entre √≠cono y t√≠tulos */
            margin-bottom: 8px;
        }

        .main-icon {
            font-size: 6.5625rem; /* Icono agrandado (105px) */
            color: var(--md-sys-color-primary);
        }

        .title-group {
            text-align: left;
        }

        .title-group h1 {
            font-size: 3rem; /* "Gran Rifa" */
            font-weight: 900;
            color: var(--md-sys-color-primary);
            text-transform: uppercase;
            margin: 0;
            line-height: 1;
        }

        .prize-subtitle {
            font-size: 1.6rem; 
            font-weight: 700; 
            color: var(--md-sys-color-on-surface);
            opacity: 0.9;
            margin: 4px 0 0 0;
            text-transform: uppercase;
            word-wrap: break-word; /* Asegura el salto de l√≠nea */
            line-height: 1.2; /* Mejora la legibilidad en multi-l√≠nea */
        }


        .raffle-motive {
            font-size: 1.1rem;
            color: var(--md-sys-color-on-surface);
            opacity: 0.8;
            margin-top: 0;
            margin-bottom: 16px;
        }
        
        /* --- ESTILO PARA EL PRECIO DE LA BOLETA --- */
        .raffle-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--md-sys-color-primary);
            margin: 0 0 16px 0;
            border: 2px solid var(--md-sys-color-primary);
            display: inline-block;
            padding: 8px 24px;
            border-radius: 50px;
            background-color: rgba(229, 57, 53, 0.05);
        }

        /* --- ESTILO PARA LA LEYENDA --- */
        #legend {
            margin-bottom: 24px;
        }
        #legend p {
            margin: 0;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        /* --- SECCI√ìN DEL GANADOR --- */
        #winner-announcement {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            padding: 24px;
            border-radius: 28px;
            margin-bottom: 32px;
            width: 100%;
            box-sizing: border-box;
            animation: fadeInScale 0.5s ease-out;
        }
        #winner-announcement.hidden {
            display: none;
        }
        #winner-announcement h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 400;
            opacity: 0.9;
        }
        #winner-announcement .winner-number {
            font-size: 6rem;
            font-weight: 900;
            line-height: 1;
            margin: 8px 0;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Tabla de la Rifa */
        .raffle-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 12px;
            margin-bottom: 32px;
            transition: opacity 0.3s ease;
        }
        .raffle-grid.ended .raffle-number {
            cursor: not-allowed;
        }

        .raffle-number {
            aspect-ratio: 1 / 1;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 500;
            font-size: 1.2rem;
            border-radius: 12px;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease;
            user-select: none;
            border: 1px solid var(--md-sys-color-outline);
        }

        .raffle-number.available { background-color: var(--raffle-color-available); cursor: pointer; }
        .raffle-number.available:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .raffle-number.pending { background-color: var(--raffle-color-pending); color: var(--raffle-text-pending); cursor: not-allowed; border-color: #FFC107;}
        .raffle-number.sold { background-color: var(--raffle-color-sold); color: var(--raffle-text-sold); cursor: not-allowed; border-color: #4CAF50; }
        
        /* Estilos para cuando la rifa termina */
        .raffle-grid.ended .raffle-number {
            background-color: var(--raffle-color-loser);
            color: var(--raffle-text-loser);
            border-color: #F44336;
        }
        .raffle-grid.ended .raffle-number.winner {
            background-color: var(--raffle-color-sold); /* Verde */
            color: var(--raffle-text-sold);
            border-color: #4CAF50;
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.7);
        }

        /* Ventana de Compra (Modal/Dialog) */
        dialog { border: 1px solid var(--md-sys-color-outline); border-radius: 28px; padding: 24px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); width: 90%; max-width: 400px; }
        dialog::backdrop { background-color: rgba(0, 0, 0, 0.4); }
        dialog h2 { margin-top: 0; color: var(--md-sys-color-on-surface); }
        dialog form { display: flex; flex-direction: column; gap: 16px; }
        dialog .form-field { display: flex; flex-direction: column; text-align: left; }
        dialog label { margin-bottom: 8px; font-size: 0.9rem; color: var(--md-sys-color-primary); }
        dialog input { padding: 12px; border-radius: 8px; border: 1px solid var(--md-sys-color-outline); font-size: 1rem; }
        dialog input:focus { outline: 2px solid var(--md-sys-color-primary); }
        dialog .actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 16px; }
        dialog button { padding: 10px 24px; border-radius: 20px; border: none; cursor: pointer; font-weight: 500; transition: background-color 0.2s; }
        dialog button[type="submit"] { background-color: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); }
        dialog button[type="submit"]:hover { opacity: 0.9; }
        dialog button#cancel-button { background-color: transparent; color: var(--md-sys-color-primary); border: 1px solid var(--md-sys-color-outline); }
        dialog button#cancel-button:hover { background-color: rgba(229, 57, 53, 0.1); } /* Hover rojo claro */

        .loader { display: flex; justify-content: center; align-items: center; padding: 40px; }

        /* --- ESTILOS RESPONSIVOS PARA M√ìVILES --- */
        @media (max-width: 600px) {
            .main-icon {
                font-size: 4.5rem; /* Reducido para m√≥viles */
            }
            .title-group h1 {
                font-size: 2.2rem; /* Reducido */
            }
            .prize-subtitle {
                font-size: 1.3rem; /* Reducido */
            }
            #winner-announcement .winner-number {
                font-size: 4rem; /* Reducido */
            }
            body {
                padding: 16px;
            }
            .raffle-grid {
                 gap: 8px;
            }
        }

    </style>
</head>
<body>
    <div class="container">
        
        <div id="winner-announcement" class="hidden">
            <h2>¬°El n√∫mero ganador es!</h2>
            <div id="winner-number-display" class="winner-number"></div>
        </div>

        <div class="header-main">
            <span class="material-symbols-outlined main-icon">confirmation_number</span>
            <div class="title-group">
                <h1 id="main-title">Gran Rifa</h1>
                <h2 id="prize-name" class="prize-subtitle">Cargando...</h2>
            </div>
        </div>
        
        <p id="raffle-motive" class="raffle-motive"></p>
        <h3 id="raffle-price" class="raffle-price"></h3>
        
        <p>¬°Selecciona tu n√∫mero de la suerte y participa!</p>

        <div id="legend">
            <p><strong>Leyenda:</strong> ‚¨ú Disponible, üü® En espera, üü© Comprado</p>
        </div>
        
        <div id="raffle-grid" class="raffle-grid">
            <div class="loader">Verificando rifa...</div>
        </div>
        
    </div>

    <dialog id="purchase-dialog">
        <h2>Comprar N√∫mero <span id="selected-number-span"></span></h2>
        <form id="purchase-form">
            <div class="form-field"><label for="name">Nombre Completo</label><input type="text" id="name" name="name" required></div>
            <div class="form-field"><label for="phone">N√∫mero de Tel√©fono</label><input type="tel" id="phone" name="phone" required></div>
            <div class="actions"><button type="button" id="cancel-button">Cancelar</button><button type="submit">Comprar y Contactar</button></div>
        </form>
    </dialog>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, getDoc, writeBatch, serverTimestamp, deleteField } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyCrF4BjP4t00rQQDEu-JOXL3rf7LVMf2O4",
            authDomain: "rifaop-82154.firebaseapp.com",
            projectId: "rifaop-82154",
            storageBucket: "rifaop-82154.appspot.com",
            messagingSenderId: "101490871954",
            appId: "1:1014908719564:web:2d512c7a53f07542f34d69",
            measurementId: "G-QWE0MXYPQT"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const WHATSAPP_NUMBER = '573180739709';
        const RAFFLE_CONFIG_DOC_ID = 'config';
        const RESERVATION_TIMEOUT = 60000; // 1 minuto para pruebas

        const raffleGrid = document.getElementById('raffle-grid');
        const prizeNameElement = document.getElementById('prize-name');
        const raffleMotiveP = document.getElementById('raffle-motive');
        const rafflePriceElement = document.getElementById('raffle-price');
        const winnerAnnouncementDiv = document.getElementById('winner-announcement');
        const winnerNumberDisplay = document.getElementById('winner-number-display');
        const purchaseDialog = document.getElementById('purchase-dialog');
        const purchaseForm = document.getElementById('purchase-form');
        const cancelButton = document.getElementById('cancel-button');
        const selectedNumberSpan = document.getElementById('selected-number-span');
        const mainTitleElement = document.getElementById('main-title');
        
        let selectedNumber = null;
        const activeReservationTimeouts = {};

        function adjustPrizeSubtitleWidth() {
            if (mainTitleElement && prizeNameElement) {
                const titleWidth = mainTitleElement.getBoundingClientRect().width;
                prizeNameElement.style.width = `${Math.ceil(titleWidth)}px`;
            }
        }
        
        function generateGrid(totalNumbers) {
            raffleGrid.innerHTML = '';
            for (let i = 1; i <= totalNumbers; i++) {
                const numberDiv = document.createElement('div');
                numberDiv.classList.add('raffle-number', 'available');
                numberDiv.textContent = i;
                numberDiv.dataset.number = i;
                raffleGrid.appendChild(numberDiv);
            }
        }
        
        async function initializeRaffle(count, prize) {
            console.log(`Inicializando nueva rifa: ${prize} con ${count} n√∫meros.`);
            raffleGrid.innerHTML = `<div class="loader">Creando rifa por primera vez...</div>`;
            const batch = writeBatch(db);

            const raffleConfigRef = doc(db, 'datosRifa', RAFFLE_CONFIG_DOC_ID);
            batch.set(raffleConfigRef, { 
                totalNumeros: count, 
                nombrePremio: prize,
                motivoRifa: "Fondos recaudados para la compra de una silla de barber√≠a.",
                precioBoleta: 5000, // Precio por defecto
                createdAt: new Date() 
            });

            for (let i = 1; i <= count; i++) {
                const numberDocRef = doc(db, 'numeros', String(i));
                batch.set(numberDocRef, { status: 'available' });
            }

            await batch.commit();
            console.log("¬°Rifa inicializada exitosamente!");
        }

        async function selectAndSetWinner(totalNumbers) {
            const winnerNumber = Math.floor(Math.random() * totalNumbers) + 1;
            console.log(`El n√∫mero ganador seleccionado es: ${winnerNumber}`);
            const raffleConfigRef = doc(db, 'datosRifa', RAFFLE_CONFIG_DOC_ID);
            try {
                await setDoc(raffleConfigRef, { numeroGanador: winnerNumber }, { merge: true });
                console.log("Ganador guardado en la base de datos.");
            } catch (error) {
                console.error("Error al guardar el ganador:", error);
            }
        }

        async function releaseNumberIfReserved(numberToRelease) {
            if (!numberToRelease) return;
            const docRef = doc(db, 'numeros', numberToRelease);
            try {
                const currentDoc = await getDoc(docRef);
                if (currentDoc.exists() && currentDoc.data().status === 'pending' && currentDoc.data().reservedAt) {
                    await setDoc(docRef, { status: 'available', reservedAt: deleteField() }, { merge: true });
                    console.log(`N√∫mero ${numberToRelease} liberado por expiraci√≥n.`);
                }
            } catch (error) {
                console.error(`Error al liberar el n√∫mero ${numberToRelease}:`, error);
            }
        }

        function listenToNumbers(totalConfiguredNumbers) {
            onSnapshot(collection(db, 'numeros'), async (snapshot) => {
                let soldCount = 0;

                snapshot.docs.forEach((docSnap) => {
                    const numberId = docSnap.id;
                    const numberData = docSnap.data();
                    const numberDiv = document.querySelector(`.raffle-number[data-number='${numberId}']`);

                    if (activeReservationTimeouts[numberId]) {
                        clearTimeout(activeReservationTimeouts[numberId]);
                        delete activeReservationTimeouts[numberId];
                    }

                    if (numberDiv) {
                        numberDiv.className = 'raffle-number';
                        numberDiv.classList.add(numberData.status || 'available');
                    }
                    if (numberData.status === 'sold') {
                        soldCount++;
                    }

                    if (numberData.status === 'pending' && numberData.reservedAt) {
                        const reservedTime = numberData.reservedAt.toDate().getTime();
                        const elapsedTime = Date.now() - reservedTime;

                        const handleExpiration = (numId) => {
                            releaseNumberIfReserved(numId);
                            if (purchaseDialog.open && selectedNumber === numId) {
                                console.log(`Cerrando di√°logo para el n√∫mero expirado: ${numId}`);
                                purchaseDialog.close();
                            }
                        };

                        if (elapsedTime >= RESERVATION_TIMEOUT) {
                            handleExpiration(numberId);
                        } else {
                            const remainingTime = RESERVATION_TIMEOUT - elapsedTime;
                            activeReservationTimeouts[numberId] = setTimeout(() => {
                                handleExpiration(numberId);
                            }, remainingTime);
                        }
                    }
                });

                const allDocsExist = snapshot.size === totalConfiguredNumbers;
                const allAreSold = soldCount === totalConfiguredNumbers;
                if (allDocsExist && allAreSold) {
                    const raffleConfigRef = doc(db, 'datosRifa', RAFFLE_CONFIG_DOC_ID);
                    const raffleConfigSnap = await getDoc(raffleConfigRef);
                    if (raffleConfigSnap.exists() && !raffleConfigSnap.data().numeroGanador) {
                        console.log("¬°Condiciones cumplidas! Todos los n√∫meros vendidos. Seleccionando un ganador...");
                        await selectAndSetWinner(totalConfiguredNumbers);
                    }
                }
            }, (error) => console.error("Error escuchando n√∫meros: ", error));
        }

        function listenToRaffleConfig() {
            const raffleConfigRef = doc(db, 'datosRifa', RAFFLE_CONFIG_DOC_ID);
            onSnapshot(raffleConfigRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().numeroGanador) {
                    const winner = docSnap.data().numeroGanador;
                    displayWinner(winner);
                }
            });
        }
        
        function displayWinner(winnerNumber) {
            winnerNumberDisplay.textContent = winnerNumber;
            winnerAnnouncementDiv.classList.remove('hidden');
            raffleGrid.classList.add('ended');
            const allNumbers = document.querySelectorAll('.raffle-number');
            allNumbers.forEach(numDiv => {
                if (numDiv.dataset.number == winnerNumber) {
                    numDiv.classList.add('winner');
                }
            });
        }

        raffleGrid.addEventListener('click', async (event) => {
            const target = event.target;
            if (target.classList.contains('available') && !raffleGrid.classList.contains('ended')) {
                selectedNumber = target.dataset.number;
                try {
                    const docRef = doc(db, 'numeros', selectedNumber);
                    await setDoc(docRef, { status: 'pending', reservedAt: serverTimestamp() }, { merge: true });
                    selectedNumberSpan.textContent = selectedNumber;
                    purchaseDialog.showModal();
                } catch (error) {
                    console.error("Error al intentar reservar el n√∫mero:", error);
                    selectedNumber = null;
                }
            }
        });
        
        purchaseForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (!selectedNumber) return;

            const purchaseData = {
                name: purchaseForm.name.value,
                phone: purchaseForm.phone.value,
                status: 'pending',
                timestamp: new Date(),
                reservedAt: deleteField() 
            };

            try {
                const docRef = doc(db, 'numeros', selectedNumber);
                await setDoc(docRef, purchaseData, { merge: true });

                const message = encodeURIComponent(`Hola, quiero comprar el n√∫mero ${selectedNumber} para la rifa de "${prizeNameElement.textContent}". Mis datos son: ${purchaseData.name}, Tel: ${purchaseData.phone}.`);
                const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${message}`;
                window.open(whatsappUrl, '_blank');
                
                purchaseDialog.close();
            } catch (error) {
                console.error("Error al guardar en Firestore: ", error);
                await releaseNumberIfReserved(selectedNumber);
                purchaseDialog.close();
            }
        });
        
        cancelButton.addEventListener('click', () => {
            purchaseDialog.close();
        });

        purchaseDialog.addEventListener('close', async () => {
            if (selectedNumber) {
                await releaseNumberIfReserved(selectedNumber);
            }
            purchaseForm.reset();
            selectedNumber = null;
        });

        async function main() {
            try {
                await signInAnonymously(auth);
                const raffleConfigRef = doc(db, 'datosRifa', RAFFLE_CONFIG_DOC_ID);
                const raffleConfigSnap = await getDoc(raffleConfigRef);

                if (!raffleConfigSnap.exists()) {
                    await initializeRaffle(100, "PREMIO INCRE√çBLE");
                } 
                
                const configData = (await getDoc(raffleConfigRef)).data();
                prizeNameElement.textContent = configData.nombrePremio;
                if(configData.motivoRifa) {
                    raffleMotiveP.textContent = configData.motivoRifa;
                }
                if (configData.precioBoleta) {
                    const formattedPrice = new Intl.NumberFormat('es-CO', {
                        style: 'currency',
                        currency: 'COP',
                        minimumFractionDigits: 0
                    }).format(configData.precioBoleta);
                    rafflePriceElement.textContent = `Valor Boleta: ${formattedPrice}`;
                } else {
                    rafflePriceElement.style.display = 'none';
                }

                document.title = `Rifa - ${configData.nombrePremio}`;
                
                generateGrid(configData.totalNumeros);
                listenToNumbers(configData.totalNumeros);
                listenToRaffleConfig();
                
                adjustPrizeSubtitleWidth();
                window.addEventListener('resize', adjustPrizeSubtitleWidth);

            } catch (error) {
                console.error("Error durante la inicializaci√≥n:", error);
                raffleGrid.innerHTML = `<div class="loader">Ocurri√≥ un error cr√≠tico.</div>`;
            }
        }

        main();
    </script>
</body>
</html>

