<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RifaOP - Gran Rifa</title>
    
    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        :root {
            --md-sys-color-primary: #6750A4;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-surface: #FFFBFE;
            --md-sys-color-on-surface: #1C1B1F;
            --md-sys-color-outline: #79747E;
            
            --raffle-color-available: #FFFFFF;
            --raffle-color-pending: #FFECB3; /* Amarillo */
            --raffle-color-sold: #C8E6C9; /* Verde */
            --raffle-color-loser: #FFCDD2; /* Rojo */
            --raffle-text-pending: #6D4C41;
            --raffle-text-sold: #1B5E20;
            --raffle-text-loser: #B71C1C;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            margin: 0;
            padding: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: 800px;
            text-align: center;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--md-sys-color-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            text-transform: uppercase;
        }
        
        /* --- SECCI√ìN DEL GANADOR --- */
        #winner-announcement {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            padding: 24px;
            border-radius: 28px;
            margin-bottom: 32px;
            width: 100%;
            box-sizing: border-box;
            animation: fadeInScale 0.5s ease-out;
        }
        #winner-announcement.hidden {
            display: none;
        }
        #winner-announcement h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 400;
            opacity: 0.9;
        }
        #winner-announcement .winner-number {
            font-size: 6rem;
            font-weight: 900;
            line-height: 1;
            margin: 8px 0;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Tabla de la Rifa */
        .raffle-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 12px;
            margin-bottom: 32px;
            transition: opacity 0.3s ease;
        }
        .raffle-grid.ended .raffle-number {
            cursor: not-allowed;
        }

        .raffle-number {
            aspect-ratio: 1 / 1;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 500;
            font-size: 1.2rem;
            border-radius: 12px;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease;
            user-select: none;
            border: 1px solid var(--md-sys-color-outline);
        }

        .raffle-number.available { background-color: var(--raffle-color-available); cursor: pointer; }
        .raffle-number.available:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .raffle-number.pending { background-color: var(--raffle-color-pending); color: var(--raffle-text-pending); cursor: not-allowed; border-color: #FFC107;}
        .raffle-number.sold { background-color: var(--raffle-color-sold); color: var(--raffle-text-sold); cursor: not-allowed; border-color: #4CAF50; }
        
        /* Estilos para cuando la rifa termina */
        .raffle-grid.ended .raffle-number {
            background-color: var(--raffle-color-loser);
            color: var(--raffle-text-loser);
            border-color: #F44336;
        }
        .raffle-grid.ended .raffle-number.winner {
            background-color: var(--raffle-color-sold); /* Verde */
            color: var(--raffle-text-sold);
            border-color: #4CAF50;
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.7);
        }

        /* Ventana de Compra (Modal/Dialog) */
        dialog { border: 1px solid var(--md-sys-color-outline); border-radius: 28px; padding: 24px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); width: 90%; max-width: 400px; }
        dialog::backdrop { background-color: rgba(0, 0, 0, 0.4); }
        dialog h2 { margin-top: 0; color: var(--md-sys-color-on-surface); }
        dialog form { display: flex; flex-direction: column; gap: 16px; }
        dialog .form-field { display: flex; flex-direction: column; text-align: left; }
        dialog label { margin-bottom: 8px; font-size: 0.9rem; color: var(--md-sys-color-primary); }
        dialog input { padding: 12px; border-radius: 8px; border: 1px solid var(--md-sys-color-outline); font-size: 1rem; }
        dialog input:focus { outline: 2px solid var(--md-sys-color-primary); }
        dialog .actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 16px; }
        dialog button { padding: 10px 24px; border-radius: 20px; border: none; cursor: pointer; font-weight: 500; transition: background-color 0.2s; }
        dialog button[type="submit"] { background-color: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); }
        dialog button[type="submit"]:hover { opacity: 0.9; }
        dialog button#cancel-button { background-color: transparent; color: var(--md-sys-color-primary); border: 1px solid var(--md-sys-color-outline); }
        dialog button#cancel-button:hover { background-color: var(--md-sys-color-primary-container); }

        .loader { display: flex; justify-content: center; align-items: center; padding: 40px; }
    </style>
</head>
<body>
    <div class="container">
        
        <div id="winner-announcement" class="hidden">
            <h2>¬°El n√∫mero ganador es!</h2>
            <div id="winner-number-display" class="winner-number"></div>
        </div>

        <h1 id="prize-name-heading">
            <span class="material-symbols-outlined">confirmation_number</span>
            <span id="prize-name">Cargando Rifa...</span>
        </h1>
        <p>¬°Selecciona tu n√∫mero de la suerte y participa!</p>

        <div id="raffle-grid" class="raffle-grid">
            <div class="loader">Verificando rifa...</div>
        </div>
        
        <div id="legend">
            <p><strong>Leyenda:</strong> ‚¨ú Disponible, üü® En espera, üü© Comprado</p>
        </div>
    </div>

    <dialog id="purchase-dialog">
        <h2>Comprar N√∫mero <span id="selected-number-span"></span></h2>
        <form id="purchase-form">
            <div class="form-field"><label for="name">Nombre Completo</label><input type="text" id="name" name="name" required></div>
            <div class="form-field"><label for="phone">N√∫mero de Tel√©fono</label><input type="tel" id="phone" name="phone" required></div>
            <div class="actions"><button type="button" id="cancel-button">Cancelar</button><button type="submit">Comprar y Contactar</button></div>
        </form>
    </dialog>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyCrF4BjP4t00rQQDEu-JOXL3rf7LVMf2O4",
            authDomain: "rifaop-82154.firebaseapp.com",
            projectId: "rifaop-82154",
            storageBucket: "rifaop-82154.appspot.com",
            messagingSenderId: "1014908719564",
            appId: "1:1014908719564:web:2d512c7a53f07542f34d69",
            measurementId: "G-QWE0MXYPQT"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- CONFIGURACI√ìN ---
        const WHATSAPP_NUMBER = '573180739709';
        
        // --- NUEVA ESTRUCTURA DE DATOS ---
        const RAFFLE_CONFIG_DOC_ID = 'config'; // ID del documento con los datos de la rifa

        // --- ELEMENTOS DEL DOM ---
        const raffleGrid = document.getElementById('raffle-grid');
        const prizeNameSpan = document.getElementById('prize-name');
        const winnerAnnouncementDiv = document.getElementById('winner-announcement');
        const winnerNumberDisplay = document.getElementById('winner-number-display');
        const purchaseDialog = document.getElementById('purchase-dialog');
        const purchaseForm = document.getElementById('purchase-form');
        const cancelButton = document.getElementById('cancel-button');
        const selectedNumberSpan = document.getElementById('selected-number-span');
        
        let selectedNumber = null;
        
        function generateGrid(totalNumbers) {
            raffleGrid.innerHTML = '';
            for (let i = 1; i <= totalNumbers; i++) {
                const numberDiv = document.createElement('div');
                numberDiv.classList.add('raffle-number', 'available');
                numberDiv.textContent = i;
                numberDiv.dataset.number = i;
                raffleGrid.appendChild(numberDiv);
            }
        }
        
        async function initializeRaffle(count, prize) {
            console.log(`Inicializando nueva rifa: ${prize} con ${count} n√∫meros.`);
            raffleGrid.innerHTML = `<div class="loader">Creando rifa por primera vez...</div>`;
            const batch = writeBatch(db);

            const raffleConfigRef = doc(db, 'datosRifa', RAFFLE_CONFIG_DOC_ID);
            batch.set(raffleConfigRef, { totalNumeros: count, nombrePremio: prize, createdAt: new Date() });

            for (let i = 1; i <= count; i++) {
                const numberDocRef = doc(db, 'numeros', String(i));
                batch.set(numberDocRef, { status: 'available' });
            }

            await batch.commit();
            console.log("¬°Rifa inicializada exitosamente!");
        }

        function listenToNumbers() {
            onSnapshot(collection(db, 'numeros'), (snapshot) => {
                snapshot.docs.forEach((docSnap) => {
                    const numberId = docSnap.id;
                    const numberData = docSnap.data();
                    const numberDiv = document.querySelector(`.raffle-number[data-number='${numberId}']`);

                    if (numberDiv) {
                        numberDiv.classList.remove('available', 'pending', 'sold');
                        if (numberData.status) {
                            numberDiv.classList.add(numberData.status);
                        } else {
                            numberDiv.classList.add('available');
                        }
                    }
                });
            }, (error) => console.error("Error escuchando n√∫meros: ", error));
        }

        function listenToRaffleConfig() {
            const raffleConfigRef = doc(db, 'datosRifa', RAFFLE_CONFIG_DOC_ID);
            onSnapshot(raffleConfigRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().numeroGanador) {
                    const winner = docSnap.data().numeroGanador;
                    displayWinner(winner);
                }
            });
        }
        
        function displayWinner(winnerNumber) {
            winnerNumberDisplay.textContent = winnerNumber;
            winnerAnnouncementDiv.classList.remove('hidden');
            raffleGrid.classList.add('ended');

            const allNumbers = document.querySelectorAll('.raffle-number');
            allNumbers.forEach(numDiv => {
                if (numDiv.dataset.number == winnerNumber) {
                    numDiv.classList.add('winner');
                }
            });
        }

        raffleGrid.addEventListener('click', (event) => {
            const target = event.target;
            if (target.classList.contains('available') && !raffleGrid.classList.contains('ended')) {
                selectedNumber = target.dataset.number;
                selectedNumberSpan.textContent = selectedNumber;
                purchaseDialog.showModal();
            }
        });
        
        purchaseForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (!selectedNumber) return;

            const purchaseData = {
                name: purchaseForm.name.value,
                phone: purchaseForm.phone.value,
                status: 'pending',
                timestamp: new Date()
            };

            try {
                const docRef = doc(db, 'numeros', selectedNumber);
                await setDoc(docRef, purchaseData, { merge: true });

                const message = encodeURIComponent(`Hola, quiero comprar el n√∫mero ${selectedNumber} para la rifa de "${prizeNameSpan.textContent}". Mis datos son: ${purchaseData.name}, Tel: ${purchaseData.phone}.`);
                const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${message}`;
                window.open(whatsappUrl, '_blank');

                purchaseDialog.close();
                purchaseForm.reset();
                selectedNumber = null;
            } catch (error) {
                console.error("Error al guardar en Firestore: ", error);
            }
        });
        
        cancelButton.addEventListener('click', () => purchaseDialog.close());

        async function main() {
            try {
                await signInAnonymously(auth);
                
                const raffleConfigRef = doc(db, 'datosRifa', RAFFLE_CONFIG_DOC_ID);
                const raffleConfigSnap = await getDoc(raffleConfigRef);

                if (!raffleConfigSnap.exists()) {
                    await initializeRaffle(100, "PREMIO INCRE√çBLE");
                } 
                
                const configData = (await getDoc(raffleConfigRef)).data();
                prizeNameSpan.textContent = configData.nombrePremio;
                document.title = `Rifa - ${configData.nombrePremio}`;
                
                generateGrid(configData.totalNumeros);
                listenToNumbers();
                listenToRaffleConfig();

            } catch (error) {
                console.error("Error durante la inicializaci√≥n:", error);
                raffleGrid.innerHTML = `<div class="loader">Ocurri√≥ un error cr√≠tico.</div>`;
            }
        }

        main();
    </script>
</body>
</html>

